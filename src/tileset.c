#include "tileset.h"

#include <string.h>
#include <assert.h>

#include <SDL_image.h>

#include "panic.h"

int tcod_tileset_chars[TILESET_CHARS_TOTAL] = {
    0x20,
    0x21,
    0x22,
    0x23,
    0x24,
    0x25,
    0x26,
    0x27,
    0x28,
    0x29,
    0x2A,
    0x2B,
    0x2C,
    0x2D,
    0x2E,
    0x2F,
    0x30,
    0x31,
    0x32,
    0x33,
    0x34,
    0x35,
    0x36,
    0x37,
    0x38,
    0x39,
    0x3A,
    0x3B,
    0x3C,
    0x3D,
    0x3E,
    0x3F,
    0x40,
    0x5B,
    0x5C,
    0x5D,
    0x5E,
    0x5F,
    0x60,
    0x7B,
    0x7C,
    0x7D,
    0x7E,
    0x2591,
    0x2592,
    0x2593,
    0x2502,
    0x2500,
    0x253C,
    0x2524,
    0x2534,
    0x251C,
    0x252C,
    0x2514,
    0x250C,
    0x2510,
    0x2518,
    0x2598,
    0x259D,
    0x2580,
    0x2596,
    0x259A,
    0x2590,
    0x2597,
    0x2191,
    0x2193,
    0x2190,
    0x2192,
    0x25B2,
    0x25BC,
    0x25C4,
    0x25BA,
    0x2195,
    0x2194,
    0x2610,
    0x2611,
    0x25CB,
    0x25C9,
    0x2551,
    0x2550,
    0x256C,
    0x2563,
    0x2569,
    0x2560,
    0x2566,
    0x255A,
    0x2554,
    0x2557,
    0x255D,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x41,
    0x42,
    0x43,
    0x44,
    0x45,
    0x46,
    0x47,
    0x48,
    0x49,
    0x4A,
    0x4B,
    0x4C,
    0x4D,
    0x4E,
    0x4F,
    0x50,
    0x51,
    0x52,
    0x53,
    0x54,
    0x55,
    0x56,
    0x57,
    0x58,
    0x59,
    0x5A,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x61,
    0x62,
    0x63,
    0x64,
    0x65,
    0x66,
    0x67,
    0x68,
    0x69,
    0x6A,
    0x6B,
    0x6C,
    0x6D,
    0x6E,
    0x6F,
    0x70,
    0x71,
    0x72,
    0x73,
    0x74,
    0x75,
    0x76,
    0x77,
    0x78,
    0x79,
    0x7A,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
    0x00,
};

void tileset_create(rg_tileset *ts,
                  SDL_Renderer *renderer,
                  const char* file,
                  int tiles_wide,
                  int tiles_high)
{
    memset(ts, 0, sizeof(rg_tileset));
    // Texture
    {
        SDL_Surface *s = IMG_Load(file);
        if (s == NULL)
            panic("failed to load tileset texture");
        ts->texture = SDL_CreateTextureFromSurface(
            renderer,
            s);
        if (ts->texture == NULL)
            panic("failed to create tileset texture from surface");
        SDL_FreeSurface(s);
    }
    int w, h;
    SDL_QueryTexture(ts->texture,
        NULL,
        NULL,
        &w,
        &h);
    ts->tile_size = w / tiles_wide;
    ts->tiles_wide = tiles_wide;
    ts->tiles_high = tiles_high;

    memcpy(ts->char_indices, tcod_tileset_chars, sizeof(ts->char_indices));

    //SRC Rects
    {
        int x = 0, y = 0;
        for (int i = 0; i < TILESET_CHARS_TOTAL; i++)
        {
            if (x + ts->tile_size > ts->tiles_wide * ts->tile_size)
            {
                x = 0;
                y += ts->tile_size;
                assert(y + ts->tile_size <= ts->tiles_high * ts->tile_size);
            }
            SDL_Rect *r = &ts->srcs[i];
            r->x = x;
            r->y = y;
            r->w = ts->tile_size;
            r->h = ts->tile_size;
            x += ts->tile_size;
        }
    }
}

void tileset_destroy(rg_tileset *ts)
{
    if (ts == NULL)
        return;
    if (ts->texture != NULL)
        SDL_DestroyTexture(ts->texture);
}